name: CI

on:
  push:
  pull_request:

# Cancel in-progress runs for the same branch (handles push+PR duplicate triggers)
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

jobs:
  format:
    name: ðŸ“ Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check formatting
        id: format
        run: |
          if ! npm run format:check 2>&1 | tee format-output.txt; then
            echo "## âŒ Formatting Check Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The following files need formatting:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat format-output.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Run \`npm run format\` to fix these issues." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "## âœ… Formatting Check Passed" >> $GITHUB_STEP_SUMMARY
          echo "All files are properly formatted." >> $GITHUB_STEP_SUMMARY

  lint:
    name: ðŸ” Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        id: lint
        run: |
          if ! npm run lint -- --format stylish 2>&1 | tee lint-output.txt; then
            echo "## âŒ Lint Check Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ESLint found the following issues:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat lint-output.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Run \`npm run lint:fix\` to auto-fix some issues." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "## âœ… Lint Check Passed" >> $GITHUB_STEP_SUMMARY
          echo "No linting issues found." >> $GITHUB_STEP_SUMMARY

  typecheck:
    name: ðŸ”· TypeScript
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        id: typecheck
        run: |
          if ! npm run typecheck 2>&1 | tee typecheck-output.txt; then
            echo "## âŒ TypeScript Check Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "TypeScript found the following type errors:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`typescript" >> $GITHUB_STEP_SUMMARY
            cat typecheck-output.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "## âœ… TypeScript Check Passed" >> $GITHUB_STEP_SUMMARY
          echo "No type errors found." >> $GITHUB_STEP_SUMMARY

  test:
    name: ðŸ§ª Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        id: test
        run: |
          if ! npm run test:coverage 2>&1 | tee test-output.txt; then
            echo "## âŒ Tests Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Test output:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            tail -100 test-output.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "## âœ… All Tests Passed" >> $GITHUB_STEP_SUMMARY

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        continue-on-error: true
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          flags: unittests
          fail_ci_if_error: false

  build:
    name: ðŸ—ï¸ Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        id: build
        run: |
          if ! npm run build 2>&1 | tee build-output.txt; then
            echo "## âŒ Build Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Build output:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat build-output.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "## âœ… Build Succeeded" >> $GITHUB_STEP_SUMMARY

      - name: Report bundle size
        run: |
          MAIN_SIZE=$(wc -c < main.js | tr -d ' ')
          MAIN_SIZE_KB=$(echo "scale=1; $MAIN_SIZE / 1024" | bc)
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Bundle Size" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| main.js | ${MAIN_SIZE_KB} KB |" >> $GITHUB_STEP_SUMMARY
          if [ -f styles.css ]; then
            CSS_SIZE=$(wc -c < styles.css | tr -d ' ')
            CSS_SIZE_KB=$(echo "scale=1; $CSS_SIZE / 1024" | bc)
            echo "| styles.css | ${CSS_SIZE_KB} KB |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: build
          path: |
            main.js
            manifest.json
            styles.css
          retention-days: 7

  # Gate job for branch protection - require this single check
  ci-success:
    name: âœ… CI Success
    runs-on: ubuntu-latest
    needs: [format, lint, typecheck, test, build]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.format.result }}" != "success" ]] || \
             [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.typecheck.result }}" != "success" ]] || \
             [[ "${{ needs.test.result }}" != "success" ]] || \
             [[ "${{ needs.build.result }}" != "success" ]]; then
            echo "## âŒ CI Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| Format | ${{ needs.format.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| TypeScript | ${{ needs.typecheck.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "## âœ… All CI Checks Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Format | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | âœ… |" >> $GITHUB_STEP_SUMMARY
